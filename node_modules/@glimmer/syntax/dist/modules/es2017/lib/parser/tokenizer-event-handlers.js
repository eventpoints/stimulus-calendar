import b, { SYNTHETIC } from '../builders';
import { appendChild, parseElementBlockParams } from '../utils';
import { HandlebarsNodeVisitors } from './handlebars-node-visitors';
import SyntaxError from '../errors/syntax-error';
import builders from '../builders';
import traverse from '../traversal/traverse';
import print from '../generation/print';
import Walker from '../traversal/walker';
import * as handlebars from 'handlebars';
import { assign } from '@glimmer/util';
import { EntityParser } from 'simple-html-tokenizer';
export const voidMap = Object.create(null);
let voidTagNames = 'area base br col command embed hr img input keygen link meta param source track wbr';
voidTagNames.split(' ').forEach(tagName => {
    voidMap[tagName] = true;
});
export class TokenizerEventHandlers extends HandlebarsNodeVisitors {
    constructor() {
        super(...arguments);
        this.tagOpenLine = 0;
        this.tagOpenColumn = 0;
    }
    reset() {
        this.currentNode = null;
    }
    // Comment
    beginComment() {
        this.currentNode = b.comment('');
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    }
    appendToCommentData(char) {
        this.currentComment.value += char;
    }
    finishComment() {
        this.currentComment.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentComment);
    }
    // Data
    beginData() {
        this.currentNode = b.text();
        this.currentNode.loc = {
            source: null,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    }
    appendToData(char) {
        this.currentData.chars += char;
    }
    finishData() {
        this.currentData.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
        appendChild(this.currentElement(), this.currentData);
    }
    // Tags - basic
    tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    }
    beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    }
    beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: SYNTHETIC
        };
    }
    finishTag() {
        let { line, column } = this.tokenizer;
        let tag = this.currentTag;
        tag.loc = b.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    }
    finishStartTag() {
        let { name, attributes: attrs, modifiers, comments, selfClosing } = this.currentStartTag;
        let loc = b.loc(this.tagOpenLine, this.tagOpenColumn);
        let element = b.element({ name, selfClosing }, { attrs, modifiers, comments, loc });
        this.elementStack.push(element);
    }
    finishEndTag(isVoid) {
        let tag = this.currentTag;
        let element = this.elementStack.pop();
        let parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        parseElementBlockParams(element);
        appendChild(parent, element);
    }
    markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    }
    // Tags - name
    appendToTagName(char) {
        this.currentTag.name += char;
    }
    // Tags - attributes
    beginAttribute() {
        let tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new SyntaxError(`Invalid end tag: closing tag must not have attributes, ` + `in \`${tag.name}\` (on line ${this.tokenizer.line}).`, tag.loc);
        }
        this.currentAttribute = {
            name: '',
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: b.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    }
    appendToAttributeName(char) {
        this.currentAttr.name += char;
    }
    beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    }
    appendToAttributeValue(char) {
        let parts = this.currentAttr.parts;
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            let loc = b.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // correct for `\n` as first char
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            }
            let text = b.text(char, loc);
            parts.push(text);
        }
    }
    finishAttributeValue() {
        let { name, parts, isQuoted, isDynamic, valueStartLine, valueStartColumn } = this.currentAttr;
        let value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = b.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        let loc = b.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        let attribute = b.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    }
    reportSyntaxError(message) {
        throw new SyntaxError(`Syntax error at line ${this.tokenizer.line} col ${this.tokenizer.column}: ${message}`, b.loc(this.tokenizer.line, this.tokenizer.column));
    }
}
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new SyntaxError(`An unquoted attribute value must be a string or a mustache, ` + `preceeded by whitespace or a '=' character, and ` + `followed by whitespace, a '>' character, or '/>' (on line ${line})`, b.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : b.text('');
    }
}
function assembleConcatenatedValue(parts) {
    for (let i = 0; i < parts.length; i++) {
        let part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new SyntaxError('Unsupported node in quoted attribute value: ' + part['type'], part.loc);
        }
    }
    return b.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    let error;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = 'Invalid end tag ' + formatEndTagInfo(tag) + ' (void elements cannot have end tags).';
    } else if (element.tag === undefined) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' without an open tag.';
    } else if (element.tag !== tag.name) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' did not match last open tag `' + element.tag + '` (on line ' + element.loc.start.line + ').';
    }
    if (error) {
        throw new SyntaxError(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return '`' + tag.name + '` (on line ' + tag.loc.end.line + ')';
}
const syntax = {
    parse: preprocess,
    builders,
    print,
    traverse,
    Walker
};
export function preprocess(html, options = {}) {
    let mode = options.mode || 'precompile';
    let ast;
    if (typeof html === 'object') {
        ast = html;
    } else {
        let parseOptions = options.parseOptions || {};
        if (mode === 'codemod') {
            parseOptions.ignoreStandalone = true;
        }
        ast = handlebars.parse(html, parseOptions);
    }
    let entityParser = undefined;
    if (mode === 'codemod') {
        entityParser = new EntityParser({});
    }
    let program = new TokenizerEventHandlers(html, entityParser).acceptTemplate(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (let i = 0, l = options.plugins.ast.length; i < l; i++) {
            let transform = options.plugins.ast[i];
            let env = assign({}, options, { syntax }, { plugins: undefined });
            let pluginResult = transform(env);
            traverse(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvcGFyc2VyL3Rva2VuaXplci1ldmVudC1oYW5kbGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLENBQVAsSUFBWSxTQUFaLFFBQTZCLGFBQTdCO0FBQ0EsU0FBUyxXQUFULEVBQXNCLHVCQUF0QixRQUFxRCxVQUFyRDtBQUNBLFNBQVMsc0JBQVQsUUFBdUMsNEJBQXZDO0FBR0EsT0FBTyxXQUFQLE1BQXdCLHdCQUF4QjtBQUVBLE9BQU8sUUFBUCxNQUFxQixhQUFyQjtBQUNBLE9BQU8sUUFBUCxNQUFxQix1QkFBckI7QUFDQSxPQUFPLEtBQVAsTUFBa0IscUJBQWxCO0FBQ0EsT0FBTyxNQUFQLE1BQW1CLHFCQUFuQjtBQUNBLE9BQU8sS0FBSyxVQUFaLE1BQTRCLFlBQTVCO0FBQ0EsU0FBUyxNQUFULFFBQXVCLGVBQXZCO0FBRUEsU0FBUyxZQUFULFFBQTZCLHVCQUE3QjtBQUVBLE9BQU8sTUFBTSxVQUVULE9BQU8sTUFBUCxDQUFjLElBQWQsQ0FGRztBQUlQLElBQUksZUFDRixxRkFERjtBQUVBLGFBQWEsS0FBYixDQUFtQixHQUFuQixFQUF3QixPQUF4QixDQUFnQyxXQUFVO0FBQ3hDLFlBQVEsT0FBUixJQUFtQixJQUFuQjtBQUNELENBRkQ7QUFJQSxPQUFNLE1BQU8sc0JBQVAsU0FBc0Msc0JBQXRDLENBQTREO0FBQWxFLGtCQUFBOztBQUNVLGFBQUEsV0FBQSxHQUFjLENBQWQ7QUFDQSxhQUFBLGFBQUEsR0FBZ0IsQ0FBaEI7QUFzTlQ7QUFwTkMsWUFBSztBQUNILGFBQUssV0FBTCxHQUFtQixJQUFuQjtBQUNEO0FBRUQ7QUFFQSxtQkFBWTtBQUNWLGFBQUssV0FBTCxHQUFtQixFQUFFLE9BQUYsQ0FBVSxFQUFWLENBQW5CO0FBQ0EsYUFBSyxXQUFMLENBQWlCLEdBQWpCLEdBQXVCO0FBQ3JCLG9CQUFRLElBRGE7QUFFckIsbUJBQU8sRUFBRSxH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TyxJQUFQLEtBQWdCLFFBQXBCLEVBQThCO0FBQzVCLGNBQU0sSUFBTjtBQUNELEtBRkQsTUFFTztBQUNMLFlBQUksZUFBZSxRQUFRLFlBQVIsSUFBd0IsRUFBM0M7QUFFQSxZQUFJLFNBQVMsU0FBYixFQUF3QjtBQUN0Qix5QkFBYSxnQkFBYixHQUFnQyxJQUFoQztBQUNEO0FBRUQsY0FBTSxXQUFXLEtBQVgsQ0FBaUIsSUFBakIsRUFBdUIsWUFBdkIsQ0FBTjtBQUNEO0FBRUQsUUFBSSxlQUFlLFNBQW5CO0FBQ0EsUUFBSSxTQUFTLFNBQWIsRUFBd0I7QUFDdEIsdUJBQWUsSUFBSSxZQUFKLENBQWlCLEVBQWpCLENBQWY7QUFDRDtBQUVELFFBQUksVUFBVSxJQUFJLHNCQUFKLENBQTJCLElBQTNCLEVBQWlDLFlBQWpDLEVBQStDLGNBQS9DLENBQThELEdBQTlELENBQWQ7QUFFQSxRQUFJLFdBQVcsUUFBUSxPQUFuQixJQUE4QixRQUFRLE9BQVIsQ0FBZ0IsR0FBbEQsRUFBdUQ7QUFDckQsYUFBSyxJQUFJLElBQUksQ0FBUixFQUFXLElBQUksUUFBUSxPQUFSLENBQWdCLEdBQWhCLENBQW9CLE1BQXhDLEVBQWdELElBQUksQ0FBcEQsRUFBdUQsR0FBdkQsRUFBNEQ7QUFDMUQsZ0JBQUksWUFBWSxRQUFRLE9BQVIsQ0FBZ0IsR0FBaEIsQ0FBb0IsQ0FBcEIsQ0FBaEI7QUFDQSxnQkFBSSxNQUFNLE9BQU8sRUFBUCxFQUFXLE9BQVgsRUFBb0IsRUFBRSxNQUFGLEVBQXBCLEVBQWdDLEVBQUUsU0FBUyxTQUFYLEVBQWhDLENBQVY7QUFFQSxnQkFBSSxlQUFlLFVBQVUsR0FBVixDQUFuQjtBQUVBLHFCQUFTLE9BQVQsRUFBa0IsYUFBYSxPQUEvQjtBQUNEO0FBQ0Y7QUFFRCxXQUFPLE9BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiLCB7IFNZTlRIRVRJQyB9IGZyb20gJy4uL2J1aWxkZXJzJztcbmltcG9ydCB7IGFwcGVuZENoaWxkLCBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IEhhbmRsZWJhcnNOb2RlVmlzaXRvcnMgfSBmcm9tICcuL2hhbmRsZWJhcnMtbm9kZS12aXNpdG9ycyc7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0ICogYXMgSEJTIGZyb20gJy4uL3R5cGVzL2hhbmRsZWJhcnMtYXN0JztcbmltcG9ydCBTeW50YXhFcnJvciBmcm9tICcuLi9lcnJvcnMvc3ludGF4LWVycm9yJztcbmltcG9ydCB7IFRhZyB9IGZyb20gJy4uL3BhcnNlcic7XG5pbXBvcnQgYnVpbGRlcnMgZnJvbSAnLi4vYnVpbGRlcnMnO1xuaW1wb3J0IHRyYXZlcnNlIGZyb20gJy4uL3RyYXZlcnNhbC90cmF2ZXJzZSc7XG5pbXBvcnQgcHJpbnQgZnJvbSAnLi4vZ2VuZXJhdGlvbi9wcmludCc7XG5pbXBvcnQgV2Fsa2VyIGZyb20gJy4uL3RyYXZlcnNhbC93YWxrZXInO1xuaW1wb3J0ICogYXMgaGFuZGxlYmFycyBmcm9tICdoYW5kbGViYXJzJztcbmltcG9ydCB7IGFzc2lnbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgTm9kZVZpc2l0b3IgfSBmcm9tICcuLi90cmF2ZXJzYWwvdmlzaXRvcic7XG5pbXBvcnQgeyBFbnRpdHlQYXJzZXIgfSBmcm9tICdzaW1wbGUtaHRtbC10b2tlbml6ZXInO1xuXG5leHBvcnQgY29uc3Qgdm9pZE1hcDoge1xuICBbdGFnTmFtZTogc3RyaW5nXTogYm9vbGVhbjtcbn0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG5sZXQgdm9pZFRhZ05hbWVzID1cbiAgJ2FyZWEgYmFzZSBiciBjb2wgY29tbWFuZCBlbWJlZCBociBpbWcgaW5wdXQga2V5Z2VuIGxpbmsgbWV0YSBwYXJhbSBzb3VyY2UgdHJhY2sgd2JyJztcbnZvaWRUYWdOYW1lcy5zcGxpdCgnICcpLmZvckVhY2godGFnTmFtZSA9PiB7XG4gIHZvaWRNYXBbdGFnTmFtZV0gPSB0cnVlO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzIGV4dGVuZHMgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyB7XG4gIHByaXZhdGUgdGFnT3BlbkxpbmUgPSAwO1xuICBwcml2YXRlIHRhZ09wZW5Db2x1bW4gPSAwO1xuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBudWxsO1xuICB9XG5cbiAgLy8gQ29tbWVudFxuXG4gIGJlZ2luQ29tbWVudCgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi5jb21tZW50KCcnKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4pLFxuICAgICAgZW5kOiAobnVsbCBhcyBhbnkpIGFzIEFTVC5Qb3NpdGlvbixcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9Db21tZW50RGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRDb21tZW50LnZhbHVlICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hDb21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudENvbW1lbnQpO1xuICB9XG5cbiAgLy8gRGF0YVxuXG4gIGJlZ2luRGF0YSgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi50ZXh0KCk7XG4gICAgdGhpcy5jdXJyZW50Tm9kZS5sb2MgPSB7XG4gICAgICBzb3VyY2U6IG51bGwsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIGVuZDogKG51bGwgYXMgYW55KSBhcyBBU1QuUG9zaXRpb24sXG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvRGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRhLmNoYXJzICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hEYXRhKCkge1xuICAgIHRoaXMuY3VycmVudERhdGEubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudERhdGEpO1xuICB9XG5cbiAgLy8gVGFncyAtIGJhc2ljXG5cbiAgdGFnT3BlbigpIHtcbiAgICB0aGlzLnRhZ09wZW5MaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLnRhZ09wZW5Db2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBiZWdpblN0YXJ0VGFnKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSB7XG4gICAgICB0eXBlOiAnU3RhcnRUYWcnLFxuICAgICAgbmFtZTogJycsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQyxcbiAgICB9O1xuICB9XG5cbiAgYmVnaW5FbmRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdFbmRUYWcnLFxuICAgICAgbmFtZTogJycsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQyxcbiAgICB9O1xuICB9XG5cbiAgZmluaXNoVGFnKCkge1xuICAgIGxldCB7IGxpbmUsIGNvbHVtbiB9ID0gdGhpcy50b2tlbml6ZXI7XG5cbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIHRhZy5sb2MgPSBiLmxvYyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4sIGxpbmUsIGNvbHVtbik7XG5cbiAgICBpZiAodGFnLnR5cGUgPT09ICdTdGFydFRhZycpIHtcbiAgICAgIHRoaXMuZmluaXNoU3RhcnRUYWcoKTtcblxuICAgICAgaWYgKHZvaWRNYXBbdGFnLm5hbWVdIHx8IHRhZy5zZWxmQ2xvc2luZykge1xuICAgICAgICB0aGlzLmZpbmlzaEVuZFRhZyh0cnVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgdGhpcy5maW5pc2hFbmRUYWcoZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmlzaFN0YXJ0VGFnKCkge1xuICAgIGxldCB7IG5hbWUsIGF0dHJpYnV0ZXM6IGF0dHJzLCBtb2RpZmllcnMsIGNvbW1lbnRzLCBzZWxmQ2xvc2luZyB9ID0gdGhpcy5jdXJyZW50U3RhcnRUYWc7XG4gICAgbGV0IGxvYyA9IGIubG9jKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbik7XG4gICAgbGV0IGVsZW1lbnQgPSBiLmVsZW1lbnQoeyBuYW1lLCBzZWxmQ2xvc2luZyB9LCB7IGF0dHJzLCBtb2RpZmllcnMsIGNvbW1lbnRzLCBsb2MgfSk7XG4gICAgdGhpcy5lbGVtZW50U3RhY2sucHVzaChlbGVtZW50KTtcbiAgfVxuXG4gIGZpbmlzaEVuZFRhZyhpc1ZvaWQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuXG4gICAgbGV0IGVsZW1lbnQgPSB0aGlzLmVsZW1lbnRTdGFjay5wb3AoKSBhcyBBU1QuRWxlbWVudE5vZGU7XG4gICAgbGV0IHBhcmVudCA9IHRoaXMuY3VycmVudEVsZW1lbnQoKTtcblxuICAgIHZhbGlkYXRlRW5kVGFnKHRhZywgZWxlbWVudCwgaXNWb2lkKTtcblxuICAgIGVsZW1lbnQubG9jLmVuZC5saW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICBlbGVtZW50LmxvYy5lbmQuY29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuXG4gICAgcGFyc2VFbGVtZW50QmxvY2tQYXJhbXMoZWxlbWVudCk7XG4gICAgYXBwZW5kQ2hpbGQocGFyZW50LCBlbGVtZW50KTtcbiAgfVxuXG4gIG1hcmtUYWdBc1NlbGZDbG9zaW5nKCkge1xuICAgIHRoaXMuY3VycmVudFRhZy5zZWxmQ2xvc2luZyA9IHRydWU7XG4gIH1cblxuICAvLyBUYWdzIC0gbmFtZVxuXG4gIGFwcGVuZFRvVGFnTmFtZShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRUYWcubmFtZSArPSBjaGFyO1xuICB9XG5cbiAgLy8gVGFncyAtIGF0dHJpYnV0ZXNcblxuICBiZWdpbkF0dHJpYnV0ZSgpIHtcbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIGlmICh0YWcudHlwZSA9PT0gJ0VuZFRhZycpIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgYEludmFsaWQgZW5kIHRhZzogY2xvc2luZyB0YWcgbXVzdCBub3QgaGF2ZSBhdHRyaWJ1dGVzLCBgICtcbiAgICAgICAgICBgaW4gXFxgJHt0YWcubmFtZX1cXGAgKG9uIGxpbmUgJHt0aGlzLnRva2VuaXplci5saW5lfSkuYCxcbiAgICAgICAgdGFnLmxvY1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRBdHRyaWJ1dGUgPSB7XG4gICAgICBuYW1lOiAnJyxcbiAgICAgIHBhcnRzOiBbXSxcbiAgICAgIGlzUXVvdGVkOiBmYWxzZSxcbiAgICAgIGlzRHluYW1pYzogZmFsc2UsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIHZhbHVlU3RhcnRMaW5lOiAwLFxuICAgICAgdmFsdWVTdGFydENvbHVtbjogMCxcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9BdHRyaWJ1dGVOYW1lKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudEF0dHIubmFtZSArPSBjaGFyO1xuICB9XG5cbiAgYmVnaW5BdHRyaWJ1dGVWYWx1ZShpc1F1b3RlZDogYm9vbGVhbikge1xuICAgIHRoaXMuY3VycmVudEF0dHIuaXNRdW90ZWQgPSBpc1F1b3RlZDtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRMaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRDb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBhcHBlbmRUb0F0dHJpYnV0ZVZhbHVlKGNoYXI6IHN0cmluZykge1xuICAgIGxldCBwYXJ0cyA9IHRoaXMuY3VycmVudEF0dHIucGFydHM7XG4gICAgbGV0IGxhc3RQYXJ0ID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07XG5cbiAgICBpZiAobGFzdFBhcnQgJiYgbGFzdFBhcnQudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgbGFzdFBhcnQuY2hhcnMgKz0gY2hhcjtcblxuICAgICAgLy8gdXBkYXRlIGVuZCBsb2NhdGlvbiBmb3IgZWFjaCBhZGRlZCBjaGFyXG4gICAgICBsYXN0UGFydC5sb2MuZW5kLmxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgICAgbGFzdFBhcnQubG9jLmVuZC5jb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGluaXRpYWxseSBhc3N1bWUgdGhlIHRleHQgbm9kZSBpcyBhIHNpbmdsZSBjaGFyXG4gICAgICBsZXQgbG9jID0gYi5sb2MoXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmNvbHVtbixcbiAgICAgICAgdGhpcy50b2tlbml6ZXIubGluZSxcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgICApO1xuXG4gICAgICAvLyBjb3JyZWN0IGZvciBgXFxuYCBhcyBmaXJzdCBjaGFyXG4gICAgICBpZiAoY2hhciA9PT0gJ1xcbicpIHtcbiAgICAgICAgbG9jLnN0YXJ0LmxpbmUgLT0gMTtcbiAgICAgICAgbG9jLnN0YXJ0LmNvbHVtbiA9IGxhc3RQYXJ0ID8gbGFzdFBhcnQubG9jLmVuZC5jb2x1bW4gOiB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRDb2x1bW47XG4gICAgICB9XG5cbiAgICAgIGxldCB0ZXh0ID0gYi50ZXh0KGNoYXIsIGxvYyk7XG4gICAgICBwYXJ0cy5wdXNoKHRleHQpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmlzaEF0dHJpYnV0ZVZhbHVlKCkge1xuICAgIGxldCB7IG5hbWUsIHBhcnRzLCBpc1F1b3RlZCwgaXNEeW5hbWljLCB2YWx1ZVN0YXJ0TGluZSwgdmFsdWVTdGFydENvbHVtbiB9ID0gdGhpcy5jdXJyZW50QXR0cjtcbiAgICBsZXQgdmFsdWUgPSBhc3NlbWJsZUF0dHJpYnV0ZVZhbHVlKHBhcnRzLCBpc1F1b3RlZCwgaXNEeW5hbWljLCB0aGlzLnRva2VuaXplci5saW5lKTtcbiAgICB2YWx1ZS5sb2MgPSBiLmxvYyh2YWx1ZVN0YXJ0TGluZSwgdmFsdWVTdGFydENvbHVtbiwgdGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGxldCBsb2MgPSBiLmxvYyhcbiAgICAgIHRoaXMuY3VycmVudEF0dHIuc3RhcnQubGluZSxcbiAgICAgIHRoaXMuY3VycmVudEF0dHIuc3RhcnQuY29sdW1uLFxuICAgICAgdGhpcy50b2tlbml6ZXIubGluZSxcbiAgICAgIHRoaXMudG9rZW5pemVyLmNvbHVtblxuICAgICk7XG5cbiAgICBsZXQgYXR0cmlidXRlID0gYi5hdHRyKG5hbWUsIHZhbHVlLCBsb2MpO1xuXG4gICAgdGhpcy5jdXJyZW50U3RhcnRUYWcuYXR0cmlidXRlcy5wdXNoKGF0dHJpYnV0ZSk7XG4gIH1cblxuICByZXBvcnRTeW50YXhFcnJvcihtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBgU3ludGF4IGVycm9yIGF0IGxpbmUgJHt0aGlzLnRva2VuaXplci5saW5lfSBjb2wgJHt0aGlzLnRva2VuaXplci5jb2x1bW59OiAke21lc3NhZ2V9YCxcbiAgICAgIGIubG9jKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbilcbiAgICApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlQXR0cmlidXRlVmFsdWUoXG4gIHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdLFxuICBpc1F1b3RlZDogYm9vbGVhbixcbiAgaXNEeW5hbWljOiBib29sZWFuLFxuICBsaW5lOiBudW1iZXJcbikge1xuICBpZiAoaXNEeW5hbWljKSB7XG4gICAgaWYgKGlzUXVvdGVkKSB7XG4gICAgICByZXR1cm4gYXNzZW1ibGVDb25jYXRlbmF0ZWRWYWx1ZShwYXJ0cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChcbiAgICAgICAgcGFydHMubGVuZ3RoID09PSAxIHx8XG4gICAgICAgIChwYXJ0cy5sZW5ndGggPT09IDIgJiZcbiAgICAgICAgICBwYXJ0c1sxXS50eXBlID09PSAnVGV4dE5vZGUnICYmXG4gICAgICAgICAgKHBhcnRzWzFdIGFzIEFTVC5UZXh0Tm9kZSkuY2hhcnMgPT09ICcvJylcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gcGFydHNbMF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgICAgYEFuIHVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZSBtdXN0IGJlIGEgc3RyaW5nIG9yIGEgbXVzdGFjaGUsIGAgK1xuICAgICAgICAgICAgYHByZWNlZWRlZCBieSB3aGl0ZXNwYWNlIG9yIGEgJz0nIGNoYXJhY3RlciwgYW5kIGAgK1xuICAgICAgICAgICAgYGZvbGxvd2VkIGJ5IHdoaXRlc3BhY2UsIGEgJz4nIGNoYXJhY3Rlciwgb3IgJy8+JyAob24gbGluZSAke2xpbmV9KWAsXG4gICAgICAgICAgYi5sb2MobGluZSwgMClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA+IDAgPyBwYXJ0c1swXSA6IGIudGV4dCgnJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzZW1ibGVDb25jYXRlbmF0ZWRWYWx1ZShwYXJ0czogKEFTVC5NdXN0YWNoZVN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSlbXSkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IHBhcnQ6IEFTVC5CYXNlTm9kZSA9IHBhcnRzW2ldO1xuXG4gICAgaWYgKHBhcnQudHlwZSAhPT0gJ011c3RhY2hlU3RhdGVtZW50JyAmJiBwYXJ0LnR5cGUgIT09ICdUZXh0Tm9kZScpIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgJ1Vuc3VwcG9ydGVkIG5vZGUgaW4gcXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZTogJyArIHBhcnRbJ3R5cGUnXSxcbiAgICAgICAgcGFydC5sb2NcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGIuY29uY2F0KHBhcnRzKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVFbmRUYWcoXG4gIHRhZzogVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz4sXG4gIGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSxcbiAgc2VsZkNsb3Npbmc6IGJvb2xlYW5cbikge1xuICBsZXQgZXJyb3I7XG5cbiAgaWYgKHZvaWRNYXBbdGFnLm5hbWVdICYmICFzZWxmQ2xvc2luZykge1xuICAgIC8vIEVuZ1RhZyBpcyBhbHNvIGNhbGxlZCBieSBTdGFydFRhZyBmb3Igdm9pZCBhbmQgc2VsZi1jbG9zaW5nIHRhZ3MgKGkuZS5cbiAgICAvLyA8aW5wdXQ+IG9yIDxiciAvPiwgc28gd2UgbmVlZCB0byBjaGVjayBmb3IgdGhhdCBoZXJlLiBPdGhlcndpc2UsIHdlIHdvdWxkXG4gICAgLy8gdGhyb3cgYW4gZXJyb3IgZm9yIHRob3NlIGNhc2VzLlxuICAgIGVycm9yID0gJ0ludmFsaWQgZW5kIHRhZyAnICsgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICsgJyAodm9pZCBlbGVtZW50cyBjYW5ub3QgaGF2ZSBlbmQgdGFncykuJztcbiAgfSBlbHNlIGlmIChlbGVtZW50LnRhZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgZXJyb3IgPSAnQ2xvc2luZyB0YWcgJyArIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArICcgd2l0aG91dCBhbiBvcGVuIHRhZy4nO1xuICB9IGVsc2UgaWYgKGVsZW1lbnQudGFnICE9PSB0YWcubmFtZSkge1xuICAgIGVycm9yID1cbiAgICAgICdDbG9zaW5nIHRhZyAnICtcbiAgICAgIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArXG4gICAgICAnIGRpZCBub3QgbWF0Y2ggbGFzdCBvcGVuIHRhZyBgJyArXG4gICAgICBlbGVtZW50LnRhZyArXG4gICAgICAnYCAob24gbGluZSAnICtcbiAgICAgIGVsZW1lbnQubG9jLnN0YXJ0LmxpbmUgK1xuICAgICAgJykuJztcbiAgfVxuXG4gIGlmIChlcnJvcikge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihlcnJvciwgZWxlbWVudC5sb2MpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGZvcm1hdEVuZFRhZ0luZm8odGFnOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPikge1xuICByZXR1cm4gJ2AnICsgdGFnLm5hbWUgKyAnYCAob24gbGluZSAnICsgdGFnLmxvYy5lbmQubGluZSArICcpJztcbn1cblxuLyoqXG4gIEFTVFBsdWdpbnMgY2FuIG1ha2UgY2hhbmdlcyB0byB0aGUgR2xpbW1lciB0ZW1wbGF0ZSBBU1QgYmVmb3JlXG4gIGNvbXBpbGF0aW9uIGJlZ2lucy5cbiovXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbkJ1aWxkZXIge1xuICAoZW52OiBBU1RQbHVnaW5FbnZpcm9ubWVudCk6IEFTVFBsdWdpbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBU1RQbHVnaW4ge1xuICBuYW1lOiBzdHJpbmc7XG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbkVudmlyb25tZW50IHtcbiAgbWV0YT86IG9iamVjdDtcbiAgc3ludGF4OiBTeW50YXg7XG59XG5pbnRlcmZhY2UgSGFuZGxlYmFyc1BhcnNlT3B0aW9ucyB7XG4gIHNyY05hbWU/OiBzdHJpbmc7XG4gIGlnbm9yZVN0YW5kYWxvbmU/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFByZXByb2Nlc3NPcHRpb25zIHtcbiAgbWV0YT86IHVua25vd247XG4gIHBsdWdpbnM/OiB7XG4gICAgYXN0PzogQVNUUGx1Z2luQnVpbGRlcltdO1xuICB9O1xuICBwYXJzZU9wdGlvbnM/OiBIYW5kbGViYXJzUGFyc2VPcHRpb25zO1xuXG4gIC8qKlxuICAgIFVzZWZ1bCBmb3Igc3BlY2lmeWluZyBhIGdyb3VwIG9mIG9wdGlvbnMgdG9nZXRoZXIuXG5cbiAgICBXaGVuIGAnY29kZW1vZCdgIHdlIGRpc2FibGUgYWxsIHdoaXRlc3BhY2UgY29udHJvbCBpbiBoYW5kbGViYXJzXG4gICAgKHRvIHByZXNlcnZlIGFzIG11Y2ggYXMgcG9zc2libGUpIGFuZCB3ZSBhbHNvIGF2b2lkIGFueVxuICAgIGVzY2FwaW5nL3VuZXNjYXBpbmcgb2YgSFRNTCBlbnRpdHkgY29kZXMuXG4gICAqL1xuICBtb2RlPzogJ2NvZGVtb2QnIHwgJ3ByZWNvbXBpbGUnO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN5bnRheCB7XG4gIHBhcnNlOiB0eXBlb2YgcHJlcHJvY2VzcztcbiAgYnVpbGRlcnM6IHR5cGVvZiBidWlsZGVycztcbiAgcHJpbnQ6IHR5cGVvZiBwcmludDtcbiAgdHJhdmVyc2U6IHR5cGVvZiB0cmF2ZXJzZTtcbiAgV2Fsa2VyOiB0eXBlb2YgV2Fsa2VyO1xufVxuXG5jb25zdCBzeW50YXg6IFN5bnRheCA9IHtcbiAgcGFyc2U6IHByZXByb2Nlc3MsXG4gIGJ1aWxkZXJzLFxuICBwcmludCxcbiAgdHJhdmVyc2UsXG4gIFdhbGtlcixcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwcm9jZXNzKGh0bWw6IHN0cmluZywgb3B0aW9uczogUHJlcHJvY2Vzc09wdGlvbnMgPSB7fSk6IEFTVC5UZW1wbGF0ZSB7XG4gIGxldCBtb2RlID0gb3B0aW9ucy5tb2RlIHx8ICdwcmVjb21waWxlJztcblxuICBsZXQgYXN0OiBIQlMuUHJvZ3JhbTtcbiAgaWYgKHR5cGVvZiBodG1sID09PSAnb2JqZWN0Jykge1xuICAgIGFzdCA9IGh0bWw7XG4gIH0gZWxzZSB7XG4gICAgbGV0IHBhcnNlT3B0aW9ucyA9IG9wdGlvbnMucGFyc2VPcHRpb25zIHx8IHt9O1xuXG4gICAgaWYgKG1vZGUgPT09ICdjb2RlbW9kJykge1xuICAgICAgcGFyc2VPcHRpb25zLmlnbm9yZVN0YW5kYWxvbmUgPSB0cnVlO1xuICAgIH1cblxuICAgIGFzdCA9IGhhbmRsZWJhcnMucGFyc2UoaHRtbCwgcGFyc2VPcHRpb25zKSBhcyBIQlMuUHJvZ3JhbTtcbiAgfVxuXG4gIGxldCBlbnRpdHlQYXJzZXIgPSB1bmRlZmluZWQ7XG4gIGlmIChtb2RlID09PSAnY29kZW1vZCcpIHtcbiAgICBlbnRpdHlQYXJzZXIgPSBuZXcgRW50aXR5UGFyc2VyKHt9KTtcbiAgfVxuXG4gIGxldCBwcm9ncmFtID0gbmV3IFRva2VuaXplckV2ZW50SGFuZGxlcnMoaHRtbCwgZW50aXR5UGFyc2VyKS5hY2NlcHRUZW1wbGF0ZShhc3QpO1xuXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGx1Z2lucyAmJiBvcHRpb25zLnBsdWdpbnMuYXN0KSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBvcHRpb25zLnBsdWdpbnMuYXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgbGV0IHRyYW5zZm9ybSA9IG9wdGlvbnMucGx1Z2lucy5hc3RbaV07XG4gICAgICBsZXQgZW52ID0gYXNzaWduKHt9LCBvcHRpb25zLCB7IHN5bnRheCB9LCB7IHBsdWdpbnM6IHVuZGVmaW5lZCB9KTtcblxuICAgICAgbGV0IHBsdWdpblJlc3VsdCA9IHRyYW5zZm9ybShlbnYpO1xuXG4gICAgICB0cmF2ZXJzZShwcm9ncmFtLCBwbHVnaW5SZXN1bHQudmlzaXRvcik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHByb2dyYW07XG59XG4iXSwic291cmNlUm9vdCI6IiJ9